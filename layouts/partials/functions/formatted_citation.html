{{- /* Hugo-safe formatted citation builder (no func) */ -}}
{{- $p := .Params -}}

{{- /* Year at end */ -}}
{{- $year := "" -}}
{{- with $p.date -}}
  {{- $year = (dateFormat "2006" .) -}}
{{- end -}}

{{- /* Journal from publication: seems like 'in *Earth System Science Data*' */ -}}
{{- $journal := $p.publication | default "" -}}
{{- $journal = replace $journal "*" "" -}}
{{- $journal = replaceRE `(?i)^\s*in\s+` "" $journal -}}
{{- $journal = trim $journal " " -}}

{{- $title := $p.title | default "" -}}
{{- $doi := $p.doi | default "" -}}

{{- /* Authors: "Logan T. Mitchell" -> "Mitchell, L. T." */ -}}
{{- $authors := $p.authors | default (slice) -}}
{{- $aFmt := slice -}}

{{- range $authors -}}
  {{- $name := trim . " " -}}
  {{- $parts := split $name " " -}}
  {{- if lt (len $parts) 2 -}}
    {{- $aFmt = $aFmt | append $name -}}
  {{- else -}}
    {{- $last := index $parts (sub (len $parts) 1) -}}
    {{- $given := first (sub (len $parts) 1) $parts -}}
    {{- $inits := slice -}}
    {{- range $given -}}
      {{- $g := . -}}
      {{- if (findRE `\.` $g) -}}
        {{- $inits = $inits | append $g -}}
      {{- else -}}
        {{- $inits = $inits | append (printf "%c." (index $g 0)) -}}
      {{- end -}}
    {{- end -}}
    {{- $aFmt = $aFmt | append (printf "%s, %s" $last (delimit $inits " ")) -}}
  {{- end -}}
{{- end -}}

{{- /* Join authors with Oxford comma and 'and' */ -}}
{{- $authorStr := "" -}}
{{- if eq (len $aFmt) 1 -}}
  {{- $authorStr = index $aFmt 0 -}}
{{- else if eq (len $aFmt) 2 -}}
  {{- $authorStr = printf "%s and %s" (index $aFmt 0) (index $aFmt 1) -}}
{{- else if gt (len $aFmt) 2 -}}
  {{- $allButLast := first (sub (len $aFmt) 1) $aFmt -}}
  {{- $lastA := index $aFmt (sub (len $aFmt) 1) -}}
  {{- $authorStr = printf "%s, and %s" (delimit $allButLast ", ") $lastA -}}
{{- end -}}

{{- /* Build: Authors, Title, Journal, doi:..., YEAR. (year at end) */ -}}
{{- $pieces := slice -}}
{{- if $authorStr }}{{- $pieces = $pieces | append $authorStr -}}{{- end -}}
{{- if $title }}{{- $pieces = $pieces | append $title -}}{{- end -}}
{{- if $journal }}{{- $pieces = $pieces | append $journal -}}{{- end -}}
{{- if $doi }}{{- $pieces = $pieces | append (printf "doi:%s" $doi) -}}{{- end -}}
{{- if $year }}{{- $pieces = $pieces | append $year -}}{{- end -}}

{{- if gt (len $pieces) 0 -}}
  {{- printf "%s." (delimit $pieces ", ") -}}
{{- end -}}

