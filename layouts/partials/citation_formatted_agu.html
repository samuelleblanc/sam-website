{{- /* Build an AGU-like plain text citation from publication front matter */ -}}

{{- $p := .Params -}}

{{- /* Year from date */ -}}
{{- $year := "" -}}
{{- with $p.date -}}
  {{- $year = (dateFormat "2006" .) -}}
{{- end -}}

{{- /* Journal: strip markdown italics and leading "in " */ -}}
{{- $journal := $p.publication | default "" -}}
{{- $journal = replace $journal "*" "" -}}
{{- $journal = replaceRE `(?i)^\s*in\s+` "" $journal -}}
{{- $journal = trim $journal " " -}}

{{- /* Author: "Logan T. Mitchell" -> "Mitchell, L. T." */ -}}
{{- $fmtAuthor := func ( $name string ) string -}}
  {{- $parts := split (trim $name " ") " " -}}
  {{- if lt (len $parts) 2 -}}
    {{- return $name -}}
  {{- end -}}
  {{- $last := index $parts (sub (len $parts) 1) -}}
  {{- $given := first (sub (len $parts) 1) $parts -}}
  {{- $inits := slice -}}
  {{- range $given -}}
    {{- $g := . -}}
    {{- if (findRE `\.` $g) -}}
      {{- /* already an initial like "T." */ -}}
      {{- $inits = $inits | append $g -}}
    {{- else -}}
      {{- $inits = $inits | append (printf "%c." (index $g 0)) -}}
    {{- end -}}
  {{- end -}}
  {{- return (printf "%s, %s" $last (delimit $inits " ")) -}}
{{- end -}}

{{- /* Join authors: A; A and B; A, B, and C */ -}}
{{- $authors := $p.authors | default (slice) -}}
{{- $aFmt := slice -}}
{{- range $authors -}}
  {{- $aFmt = $aFmt | append ($fmtAuthor .) -}}
{{- end -}}

{{- $authorStr := "" -}}
{{- if eq (len $aFmt) 1 -}}
  {{- $authorStr = index $aFmt 0 -}}
{{- else if eq (len $aFmt) 2 -}}
  {{- $authorStr = printf "%s and %s" (index $aFmt 0) (index $aFmt 1) -}}
{{- else if gt (len $aFmt) 2 -}}
  {{- $allButLast := first (sub (len $aFmt) 1) $aFmt -}}
  {{- $lastA := index $aFmt (sub (len $aFmt) 1) -}}
  {{- $authorStr = printf "%s, and %s" (delimit $allButLast ", ") $lastA -}}
{{- end -}}

{{- /* Build citation; keep it conservative since volume/pages aren't in your front matter */ -}}
{{- $title := $p.title | default "" -}}
{{- $doi := $p.doi | default "" -}}

{{- $pieces := slice -}}
{{- if $authorStr }}{{- $pieces = $pieces | append $authorStr -}}{{- end -}}
{{- if $title }}{{- $pieces = $pieces | append (printf "%s" $title) -}}{{- end -}}
{{- if $journal }}{{- $pieces = $pieces | append $journal -}}{{- end -}}
{{- if $doi }}{{- $pieces = $pieces | append (printf "doi:%s" $doi) -}}{{- end -}}
{{- if $year }}{{- $pieces = $pieces | append $year -}}{{- end -}}

{{- /* Output as one sentence-ish string */ -}}
{{- printf "%s." (delimit $pieces ", ") -}}

